<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.hoooosi.imagehosting.mapper.SpaceMapper">
    <sql id="select">
        WITH "tb" AS (SELECT s.id,
                             s.name,
                             s.max_size,
                             s.total_size,
                             s.public_permission_mask,
                             s.member_permission_mask,
                             s.create_time,
                             s.update_time,
                             COALESCE(m.permission_mask, 0) AS permission_mask
                      FROM "tb_space" s
                               LEFT JOIN
                           "tb_member" m ON s.id = m.space_id AND m.user_id = #{userId})
        SELECT *
        FROM "tb"
    </sql>

    <select id="query" resultType="io.github.hoooosi.imagehosting.vo.SpaceVO">
        <include refid="select"/>
        <where>
            <if test="ew != null and ew.sqlSegment != null and ew.sqlSegment != ''">
                ${ew.sqlSegment}
            </if>
        </where>
    </select>
</mapper>